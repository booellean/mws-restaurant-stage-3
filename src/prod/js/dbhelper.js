"use strict";var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor}}();function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}var restaurantBackup=void 0,reviewBackup=void 0,idbName="restaurant-data",idbResTx="restaurant",idbRevTx="review",idbRevForm="reviews-to-submit",dbPromise=idb.open(idbName,1,function(upgradeDB){var restaurants=upgradeDB.createObjectStore(idbResTx,{keyPath:"id"}),reviews;upgradeDB.createObjectStore(idbRevTx,{keyPath:"id"}).createIndex("restaurant","restaurant_id");var reviewsToSubmit=upgradeDB.createObjectStore(idbRevForm,{keyPath:"createdAt"})});window.onload=function(){dbPromise.then(function(db){return db.transaction(idbRevForm).objectStore(idbRevForm).getAll()}).then(function(allReviews){if(0!=allReviews.length){var reviews=allReviews;dbPromise.then(function(db){var tx,keyValStore=db.transaction(idbRevForm,"readwrite").objectStore(idbRevForm);reviews.forEach(function(review){DBHelper.submitReview(review),keyValStore.delete(review.createdAt)})})}})};var DBHelper=function(){function DBHelper(){_classCallCheck(this,DBHelper)}return _createClass(DBHelper,null,[{key:"DATABASE_URL",value:function DATABASE_URL(dbsection){var port=1337;return"http://localhost:1337/"+dbsection}},{key:"fetchRestaurants",value:function fetchRestaurants(dbsection){fetch(DBHelper.DATABASE_URL(dbsection)).then(function(response){var restaurants;return response.json()}).then(function(restaurants){if(window.indexedDB){var items=restaurants;dbPromise.then(function(db){var tx,keyValStore;return db.transaction(idbResTx,"readwrite").objectStore(idbResTx).count()}).then(function(count){return count!=items.length?items:items=null}).then(function(restaurants){return console.log(restaurants),null!=restaurants&&dbPromise.then(function(db){var tx,keyValStore=db.transaction(idbResTx,"readwrite").objectStore(idbResTx);restaurants.forEach(function(restaurant){keyValStore.put({id:restaurant.id,name:restaurant.name,neighborhood:restaurant.neighborhood,photograph:restaurant.photograph,ext:restaurant.ext,alt:restaurant.alt,address:restaurant.address,latlng:restaurant.latlng,cuisine_type:restaurant.cuisine_type,operating_hours:restaurant.operating_hours,is_favorite:restaurant.is_favorite})})}),initPage()})}else restaurantBackup=restaurants}).catch(function(error){return console.log(error),restaurantBackup=null,initPage()})}},{key:"fetchReviews",value:function fetchReviews(dbsection){var url,stringID=window.location.search.split("?id=")[1],id=parseInt(stringID);fetch(DBHelper.DATABASE_URL(dbsection)).then(function(response){var reviews;return response.json()}).then(function(reviews){if(window.indexedDB){var items=void 0;dbPromise.then(function(db){var tx,keyValStore;return items=reviews,db.transaction(idbRevTx,"readwrite").objectStore(idbRevTx).count()}).then(function(count){return items}).then(function(reviews){return console.log(reviews),null!=reviews&&dbPromise.then(function(db){var tx,keyValStore=db.transaction(idbRevTx,"readwrite").objectStore(idbRevTx);reviews.forEach(function(review){var unixDate,options={weekday:"long",month:"long",day:"numeric",year:"numeric",hour:"numeric",minute:"numeric"},formatDate=new Date(review.createdAt).toLocaleDateString("en-US",options);keyValStore.put({id:review.id,restaurant_id:review.restaurant_id,name:review.name,createdAt:formatDate,updatedAt:review.updatedAt,rating:review.rating,comments:review.comments})})}),DBHelper.fetchRestaurants("restaurants")})}else reviewBackup=reviews}).catch(function(error){return console.log(error),reviewBackup=null,DBHelper.fetchRestaurants("restaurants")})}},{key:"fetchRestaurantById",value:function fetchRestaurantById(id,error){error?fillFetchedRestaurantFromURL(error,null):dbPromise.then(function(db){var tx,keyValStore,restaurants;return db.transaction(idbResTx).objectStore(idbResTx).getAll()}).then(function(restaurants){var restaurant=restaurants.find(function(r){return r.id==id});restaurant?fillFetchedRestaurantFromURL(null,restaurant):fillFetchedRestaurantFromURL("Restaurant does not exist",null)})}},{key:"fetchRestaurantByCuisineAndNeighborhood",value:function fetchRestaurantByCuisineAndNeighborhood(cuisine,neighborhood,error){null===restaurantBackup?fillUpdatedRestaurants(error,null):dbPromise.then(function(db){var tx,keyValStore,restaurants;return db.transaction(idbResTx).objectStore(idbResTx).getAll()}).then(function(restaurants){var results=restaurants;"all"!=cuisine&&(results=results.filter(function(r){return r.cuisine_type==cuisine})),"all"!=neighborhood&&(results=results.filter(function(r){return r.neighborhood==neighborhood})),fillUpdatedRestaurants(null,results)})}},{key:"fetchNeighborhoods",value:function(_fetchNeighborhoods){function fetchNeighborhoods(_x){return _fetchNeighborhoods.apply(this,arguments)}return fetchNeighborhoods.toString=function(){return _fetchNeighborhoods.toString()},fetchNeighborhoods}(function(error){null===restaurantBackup?fetchNeighborhoods(error,null):dbPromise.then(function(db){var tx,keyValStore,restaurants;return db.transaction(idbResTx).objectStore(idbResTx).getAll()}).then(function(restaurants){var neighborhoods=restaurants.map(function(v,i){return restaurants[i].neighborhood}),uniqueNeighborhoods=neighborhoods.filter(function(v,i){return neighborhoods.indexOf(v)==i});fetchNeighborhoods(null,uniqueNeighborhoods)})})},{key:"fetchCuisines",value:function(_fetchCuisines){function fetchCuisines(_x2){return _fetchCuisines.apply(this,arguments)}return fetchCuisines.toString=function(){return _fetchCuisines.toString()},fetchCuisines}(function(error){error?fetchCuisines(error,null):dbPromise.then(function(db){var tx,keyValStore,restaurants;return db.transaction(idbResTx).objectStore(idbResTx).getAll()}).then(function(restaurants){var cuisines=restaurants.map(function(v,i){return restaurants[i].cuisine_type}),uniqueCuisines=cuisines.filter(function(v,i){return cuisines.indexOf(v)==i});fetchCuisines(null,uniqueCuisines)})})},{key:"fillReviewsHTML",value:function(_fillReviewsHTML){function fillReviewsHTML(_x3,_x4){return _fillReviewsHTML.apply(this,arguments)}return fillReviewsHTML.toString=function(){return _fillReviewsHTML.toString()},fillReviewsHTML}(function(id,error){error?fillReviewsHTML(error,null):dbPromise.then(function(db){var tx,keyValStore,reviews;return db.transaction(idbRevTx).objectStore(idbRevTx).index("restaurant").getAll(id)}).then(function(reviews){fillReviewsHTML(reviews)})})},{key:"submitReview",value:function submitReview(review){var data=review;fetch(DBHelper.DATABASE_URL("reviews/"),{method:"POST",body:JSON.stringify(data),mode:"cors",redirect:"follow",headers:{"Content-Type":"application/json"}}).then(function(response){console.log(response)}).catch(function(error){console.log(error);var catchdata=data;dbPromise.then(function(db){var tx;db.transaction(idbRevForm,"readwrite").objectStore(idbRevForm).put({restaurant_id:catchdata.restaurant_id,name:catchdata.name,createdAt:catchdata.createdAt,updatedAt:catchdata.updatedAt,rating:catchdata.rating,comments:catchdata.comments})})})}},{key:"toggleFavorite",value:function toggleFavorite(id,name,e){var button=document.querySelector("#button"+id),favBoolean,restaurant=name,boolean=void 0;switch(button.getAttribute("data-name")){case"false":button.setAttribute("data-name","true"),button.setAttribute("aria-label","Favorite: "+restaurant),button.classList.remove("star-empty"),button.classList.add("star-full"),boolean=!0;break;case"true":button.setAttribute("data-name","false"),button.setAttribute("aria-label","Not Favorite: "+restaurant),button.classList.remove("star-full"),button.classList.add("star-empty"),boolean=!1;break;default:console.log("boolean is invalid???")}console.log(boolean),fetch(DBHelper.DATABASE_URL("restaurants/"+id+"/?is_favorite="+boolean),{method:"PUT",mode:"cors",redirect:"follow"}).then(function(response){dbPromise.then(function(db){var tx,keyValStore;return db.transaction(idbResTx,"readwrite").objectStore(idbResTx).get(id)}).then(function(resObject){var restaurant=resObject;dbPromise.then(function(db){var tx,keyValStorage;return db.transaction(idbResTx,"readwrite").objectStore(idbResTx).put({id:restaurant.id,address:restaurant.address,alt:restaurant.alt,cuisine_type:restaurant.cuisine_type,ext:restaurant.ext,is_favorite:boolean,latlng:restaurant.latlng,name:restaurant.name,neighborhood:restaurant.neighborhood,operating_hours:restaurant.operating_hours,photograph:restaurant.photograph})})})}).catch(function(error){console.log(error)}),e.preventDefault()}},{key:"urlForRestaurant",value:function urlForRestaurant(restaurant){return"./restaurant.html?id="+restaurant.id}},{key:"imageUrlForRestaurant",value:function imageUrlForRestaurant(restaurant){return"/img/"+restaurant.photograph+restaurant.ext}},{key:"imageSrcsetForRestaurant",value:function imageSrcsetForRestaurant(restaurant){return"/img/"+restaurant.photograph+"-200"+restaurant.ext+" 400w,\n\t\t\t /img/"+restaurant.photograph+"-400"+restaurant.ext+" 600w,\n\t\t\t /img/"+restaurant.photograph+"-600"+restaurant.ext+" 800w,\n\t\t\t /img/"+restaurant.photograph+restaurant.ext+" 1000w"}},{key:"imageSizesForRestaurant",value:function imageSizesForRestaurant(restaurant){return"(max-width: 320px) 400w,\n\t          (max-width: 400px) 600w,\n\t\t\t      (max-width: 600px) 800w,\n\t\t\t      1000w"}},{key:"mapMarkerForRestaurant",value:function mapMarkerForRestaurant(restaurant,map){var marker=new L.marker([restaurant.latlng.lat,restaurant.latlng.lng],{title:restaurant.name,alt:restaurant.name+"location marker",url:DBHelper.urlForRestaurant(restaurant)});return marker.addTo(newMap),marker}}]),DBHelper}();